<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vending Machine</title>

  <link rel="stylesheet" href="vendingMachine.css">

</head>
<body>

  <div id="wrapper">
    <div class="vendingMachine" id="front">

      <div class="vendingMachine" id="storage">
        
        <div class="vendingMachine" id="rows">
          <table>
            <tbody>
              <tr class="row1">
                <td class="col1 slot"></td>
                <td class="col2 slot"></td>
                <td class="col3 slot"></td>
              </tr>
              <tr class="row2">
                <td class="col1 slot"></td>
                <td class="col2 slot"></td>
                <td class="col3 slot"></td>
              </tr>
              <tr class="row3">
                <td class="col1 slot"></td>
                <td class="col2 slot"></td>
                <td class="col3 slot"></td>
              </tr>
              <tr class="row4">
                <td class="col1 slot"></td>
                <td class="col2 slot"></td>
                <td class="col3 slot"></td>
              </tr>
            </tbody>
          </table>

        </div>

      </div>
      <div class="vendingMachine" id="window">

      </div>

      <div class="vendingMachine" id="keypadFrame">
        <div class="vendingMachine" id="lcdScreen">

        </div>

        <div class="vendingMachine" id="numPad">

        </div>
      </div>

      <div class="vendingMachine" id="billSlot">

      </div>

      <div class="vendingMachine" id="coinSlot">

      </div>

      <div class="vendingMachine" id="changeReturn">
        <div></div>
      </div>

      <div class="vendingMachine" id="itemRetrieval">

      </div>

    </div>
  </div>

  <div id="buyItem">Buy Item</div><br><br>
  <div id="playerInfo">See Player Info</div><br><br>
  <div id="addMoneys">Aquire Currency</div><br><br>
  <div>Current Currency: <span id="currentCurrency">0</span></div>
  
  <script src="../../src/js/Collectibles.js" type="module"></script>
  <script src="../../src/js/Boons.js" type="module"></script>
  <script src="../../src/js/Player.js" type="module"></script>
  <script src="../../test/gameplay/Boon.js" type="module"></script>
  <script type="module">
    import { Player } from "../../src/js/Player.js";
    import { Collectibles } from "../../src/js/Collectibles.js";
    import { Boons } from "../../src/js/Boons.js";
    import { Boon } from "../../test/gameplay/Boon.js";
    import { boonArray } from "../../test/gameplay/Boon.js";
    import { boonNameArray } from "../../test/gameplay/Boon.js";

    let player = new Player();

    let activeBoon = new Boon("", "", "", "");

    const shopContent = document.querySelectorAll('.slot');
    
    // player.addConsumable(boonArray["MONEY!"]);
    // player.addConsumable(boonArray["Stamina Potion"]);
    // player.addConsumable(boonArray["beamSword"]);
    // player.addConsumable(boonArray["chaosEmerald"]);
    // player.addConsumable(boonArray["companionCube"]);
    // player.addConsumable(boonArray["crowbar"]);
    // player.addConsumable(boonArray["elderScroll"]);
    // player.addConsumable(boonArray["estusFlask"]);
    // player.addConsumable(boonArray["gloves"]);
    // player.addConsumable(boonArray["goggles"]);
    // player.addConsumable(boonArray["labCoat"]);
    // player.addConsumable(boonArray["lollipops"]);
    // player.addConsumable(boonArray["mask"]);
    // player.addConsumable(boonArray["medicalBag"]);
    // player.addConsumable(boonArray["mushroom"]);
    // player.addConsumable(boonArray["nukaCola"]);
    // player.addConsumable(boonArray["pickaxe"]);
    // player.addConsumable(boonArray["pillBottle"]);
    // player.addConsumable(boonArray["pokeball"]);
    // player.addConsumable(boonArray["portalGun"]);
    // player.addConsumable(boonArray["reflexHammer"]);
    // player.addConsumable(boonArray["rxPad"]);
    // player.addConsumable(boonArray["scalpel"]);
    
    let bannedArray = [];
    for (let i = 0; i < player.viceArray.length; i++) {
      bannedArray.push(player.viceArray[i]);
    }
    
    shopContent.forEach(shopItem => {
      // Get random boon
      
      let boon = "";
      let fullyPopulated = false;

      while (boon === "" && !fullyPopulated) { // Use equality operator '===' to compare
        let randBoon = Math.floor(Math.random() * boonNameArray.length);
        let tempBoon = boonArray[boonNameArray[randBoon]];

        if (!bannedArray.includes(tempBoon)) {
          bannedArray.push(tempBoon);
          boon = tempBoon;
        }

        if (bannedArray.length === boonNameArray.length) {
          fullyPopulated = true;
        }
      }
      

      // Set shop HTML to match boon

      shopItem.innerHTML = `
      <img src="../../${boon.filePath}" class="boon">
        <span class="tooltip">
        ${boon.description}              
        </span>
      `;

      shopItem.id = boon.name;

      shopItem.addEventListener("click", function() {
        activeBoon = boonArray[shopItem.id];

        let tooltip = shopItem.querySelector(".tooltip");
        let alreadyDisplayed = (tooltip.style.display == "block");

        let allTooltips = document.querySelectorAll('.tooltip');
        allTooltips.forEach(tip => {
          tip.style.display = "none";
        });


        if (alreadyDisplayed) {
          tooltip.style.display = 'none';
        } else {
          tooltip.style.display = 'block';
        }

      });
 
    });


    document.querySelector("#playerInfo").addEventListener("click", function() {
      console.log(player.viceArray);
      console.log(player.currency);
    });

    // This currently works by replicating the boon used to populate the shotItem div. In order to correctly 
    // serve the player the correct item, the id is used to make a new one to give to the player. 
    // However, we'll need to refactor the contructor to allow for variable costed boons

    document.querySelector("#buyItem").addEventListener("click", function() {
      if (activeBoon.name != "") {
        if (player.subtractCurrency(15)) {
          document.querySelector("#currentCurrency").innerHTML = player.currency;
          player.addConsumable(activeBoon);
          let selected = document.querySelector(`#${activeBoon.name}`);
          if (selected) {
            selected.style.opacity = 0;
            selected.id = ``;
          }
          activeBoon = new Boon("", "", "", "");
        }
      }
    });

    document.querySelector("#addMoneys").addEventListener("click", function() {
      player.currency += 10;
      document.querySelector("#currentCurrency").innerHTML = player.currency;
    });


  </script>
  <script>

    // document.getElementById("defaultOpen").click();

    function openTab(event, tabName) {
      var tabcontent = document.getElementsByClassName("shopTabcontent");
      for (var i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      var tablinks = document.getElementsByClassName("tablinks");
      for (var i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }

      document.getElementById(tabName).style.display = "block";
      event.currentTarget.className += " active";
    }

    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    if (tab === 'diceMachine') {
      openTab(event, 'diceMachine');
    }

  </script>
</body>
</html>